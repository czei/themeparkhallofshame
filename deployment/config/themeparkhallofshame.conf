# Theme Park Hall of Shame - Apache Virtual Host Configuration
# Domain: themeparkhallofshame.com
#
# STAGED ROLLOUT:
# - Phase 1 (Soft Launch): Site live with Basic Auth protection
# - Phase 2 (Public): Remove Basic Auth, run certbot for SSL
#
# To remove Basic Auth for public launch:
#   1. Comment out or remove the <Location /> auth block below
#   2. sudo systemctl reload httpd

<VirtualHost *:80>
    ServerName themeparkhallofshame.com
    ServerAlias www.themeparkhallofshame.com
    # Allow access via IP during soft launch (no DNS)
    ServerAlias localhost

    # Document root for static frontend files
    DocumentRoot /var/www/themeparkhallofshame

    # Frontend directory settings
    <Directory /var/www/themeparkhallofshame>
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride None

        # SPA routing - serve index.html for all non-file requests
        RewriteEngine On
        RewriteBase /
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api
        RewriteRule ^ index.html [L]
    </Directory>

    # ==========================================================================
    # SOFT LAUNCH: Basic Authentication (remove this block for public launch)
    # ==========================================================================
    # To create the password file on the server:
    #   sudo htpasswd -c /etc/httpd/.htpasswd-themepark <username>
    #
    # To add additional users (without -c flag):
    #   sudo htpasswd /etc/httpd/.htpasswd-themepark <another-user>
    # ==========================================================================
    <Location />
        AuthType Basic
        AuthName "Theme Park Hall of Shame - Soft Launch"
        AuthUserFile /etc/httpd/.htpasswd-themepark
        Require valid-user
    </Location>

    # Cache static assets
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=86400, public"
    </FilesMatch>

    # Don't cache HTML
    <FilesMatch "\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>

    # Proxy /api requests to Flask backend (Gunicorn on port 5001)
    ProxyPreserveHost On
    ProxyPass /api http://127.0.0.1:5001/api
    ProxyPassReverse /api http://127.0.0.1:5001/api

    # Proxy timeout settings
    ProxyTimeout 120

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Logging
    ErrorLog /opt/themeparkhallofshame/logs/apache-error.log
    CustomLog /opt/themeparkhallofshame/logs/apache-access.log combined

    # Log level (change to debug for troubleshooting)
    LogLevel warn
</VirtualHost>

# Note: After running certbot, an SSL VirtualHost will be added automatically
# Run: sudo certbot --apache -d themeparkhallofshame.com -d www.themeparkhallofshame.com
